<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Final OHCAO</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .quiz-container { margin-top: 20px; }
    button { padding: 10px 20px; margin-top: 10px; }
    table { border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #000; padding: 5px; }
  </style>
</head>
<body>

<h1>Quiz OHCAO</h1>

<!-- LOGIN -->
<div id="loginDiv">
  <label>Nome: <input type="text" id="nameInput"></label><br>
  <label>Torre: <input type="text" id="towerInput"></label><br>
  <label>Apartamento: <input type="text" id="apartmentInput"></label><br>
  <label>Idade: <input type="number" id="ageInput"></label><br>
  <button id="loginBtn">Iniciar Quiz</button>
</div>

<!-- QUIZ -->
<div id="quizDiv" class="quiz-container hidden">
  <div id="questionText"></div>
  <div id="optionsDiv"></div>
  <button id="nextBtn">Próxima</button>
</div>

<!-- RESULTADO -->
<div id="resultDiv" class="hidden">
  <h2>Resultado</h2>
  <div id="scoreText"></div>
  <button id="downloadCSVBtn">Download CSV</button>
  <div id="summaryDiv"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtSr5znaGgvN9ZyITfCJzZD4jRpthAat0",
  authDomain: "trabalho-final-ohcao.firebaseapp.com",
  projectId: "trabalho-final-ohcao",
  storageBucket: "trabalho-final-ohcao.appspot.com",
  messagingSenderId: "588002956461",
  appId: "1:588002956461:web:12eec38aceece890e56224"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ------------------------------
// VARIÁVEIS DO QUIZ
// ------------------------------
let currentUser = null;
let currentQuestionIndex = 0;
let score = 0;

const SCENARIOS = [
  { question: "Pergunta 1", options: ["A","B","C"], answer: "A" },
  { question: "Pergunta 2", options: ["A","B","C"], answer: "B" },
  { question: "Pergunta 3", options: ["A","B","C"], answer: "C" }
];

// ------------------------------
// LOGIN
// ------------------------------
document.getElementById("loginBtn").addEventListener("click", () => {
  const name = document.getElementById("nameInput").value.trim();
  const tower = document.getElementById("towerInput").value.trim();
  const apartment = document.getElementById("apartmentInput").value.trim();
  const ageValue = document.getElementById("ageInput").value.trim();
  let age = parseInt(ageValue) || 0;

  currentUser = { name, tower, apartment, age };

  if(name.toLowerCase() !== "uninter") {
    if(!name || !tower || !apartment || !age) {
      alert("Por favor, preencha todos os campos!");
      return;
    }
  } else {
    currentUser.age = null; // UNINTER não precisa
  }

  document.getElementById("loginDiv").classList.add("hidden");
  document.getElementById("quizDiv").classList.remove("hidden");

  showQuestion();
});

// ------------------------------
// QUIZ
// ------------------------------
function showQuestion() {
  if(currentQuestionIndex >= SCENARIOS.length) {
    finishQuiz();
    return;
  }

  const q = SCENARIOS[currentQuestionIndex];
  document.getElementById("questionText").textContent = q.question;

  const optionsDiv = document.getElementById("optionsDiv");
  optionsDiv.innerHTML = "";
  q.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.onclick = () => selectAnswer(opt);
    optionsDiv.appendChild(btn);
  });
}

function selectAnswer(answer) {
  if(answer === SCENARIOS[currentQuestionIndex].answer) score++;
  currentQuestionIndex++;
  showQuestion();
}

function finishQuiz() {
  document.getElementById("quizDiv").classList.add("hidden");
  document.getElementById("resultDiv").classList.remove("hidden");
  document.getElementById("scoreText").textContent = `Você acertou ${score} de ${SCENARIOS.length} perguntas.`;
  saveResult(score);
  if(currentUser.name.toLowerCase() === "uninter") showSummaryByAge();
}

// ------------------------------
// SALVAR RESULTADO NO FIRESTORE
// ------------------------------
async function saveResult(score) {
  await addDoc(collection(db, "quizResults"), {
    name: currentUser.name,
    tower: currentUser.tower,
    apartment: currentUser.apartment,
    age: currentUser.age,
    score: score,
    timestamp: new Date()
  });
}

// ------------------------------
// DOWNLOAD CSV
// ------------------------------
document.getElementById("downloadCSVBtn").addEventListener("click", async () => {
  const snapshot = await getDocs(query(collection(db, "quizResults"), orderBy("score", "desc")));
  const results = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  const rows = [["Nome","Torre","Apartamento","Idade","Pontuação","Data/Hora"]];
  results.forEach(u => {
    let dateStr = "";
    if(u.timestamp && u.timestamp.seconds) {
      dateStr = new Date(u.timestamp.seconds * 1000).toLocaleString();
    } else if(u.timestamp) {
      dateStr = new Date(u.timestamp).toLocaleString();
    }
    rows.push([u.name, u.tower, u.apartment, u.age ?? "", u.score, dateStr]);
  });

  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "resultados_quiz.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// ------------------------------
// RESUMO POR FAIXA ETÁRIA (UNINTER)
// ------------------------------
async function showSummaryByAge() {
  const snapshot = await getDocs(collection(db, "quizResults"));
  const results = snapshot.docs.map(doc => doc.data());

  const summary = {};
  results.forEach(u => {
    if(!u.age) return;
    const faixa = `${Math.floor(u.age/10)*10}-${Math.floor(u.age/10)*10+9}`;
    if(!summary[faixa]) summary[faixa] = 0;
    summary[faixa]++;
  });

  const summaryDiv = document.getElementById("summaryDiv");
  summaryDiv.innerHTML = "<h3>Resumo por faixa etária:</h3>";

  const table = document.createElement("table");
  const header = document.createElement("tr");
  header.innerHTML = "<th>Faixa Etária</th><th>Quantidade</th>";
  table.appendChild(header);

  for(const faixa in summary) {
    const row = document.createElement("tr");
    row.innerHTML = `<td>${faixa}</td><td>${summary[faixa]}</td>`;
    table.appendChild(row);
  }

  summaryDiv.appendChild(table);
}

</script>
</body>
</html>
