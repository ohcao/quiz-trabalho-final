<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Segurança Digital - Terceira Idade</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 20px;
    color: #333;
    display: flex;
    justify-content: center;
  }
  #container {
    background: white;
    max-width: 600px;
    width: 100%;
    border-radius: 10px;
    padding: 25px 30px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  h2, h3 { color: #005a87; }
  label { display: block; margin: 15px 0 5px; font-weight: 600; }
  input[type=text], input[type=number] {
    width: 100%;
    padding: 12px 10px;
    font-size: 1.1em;
    border: 1.8px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.3s;
  }
  input[type=text]:focus, input[type=number]:focus {
    border-color: #005a87;
    outline: none;
  }
  button {
    cursor: pointer;
    margin: 10px 10px 0 0;
    padding: 12px 24px;
    font-size: 1.1em;
    border: none;
    border-radius: 7px;
    background-color: #007acc;
    color: white;
    transition: background-color 0.3s;
  }
  button:hover:not(:disabled) { background-color: #005a87; }
  button:disabled { background-color: #a3c1db; cursor: default; }
  #feedbackBox {
    margin-top: 15px;
    font-weight: 700;
    font-size: 1.1em;
  }
  #feedbackBox.correct { color: #2d7a2d; }
  #feedbackBox.wrong { color: #c0392b; }
  #userInfo {
    margin-bottom: 20px;
    font-weight: 600;
    color: #004c6d;
  }
  #quizScreen, #resultScreen { display: none; }
  table {
    border-collapse: collapse;
    margin-top: 20px;
    width: 100%;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 12px 10px;
    text-align: center;
  }
  th { background-color: #007acc; color: white; }
  @media(max-width: 480px) {
    body { padding: 10px; }
    #container { padding: 20px 15px; }
    button { width: 100%; margin: 10px 0 0 0; }
  }
</style>
</head>
<body>
  <div id="container">

    <div id="startScreen">
      <h2>Cadastro do Morador</h2>
      <label for="name">Nome:</label>
      <input type="text" id="name" autocomplete="off" />

      <label for="age">Idade:</label>
      <input type="number" id="age" min="1" max="120" />

      <label for="tower">Torre (1 a 6):</label>
      <input type="number" id="tower" min="1" max="6" />

      <label for="apartment">Apartamento (ex: 101–108, 201–208, ..., 1201–1208):</label>
      <input type="number" id="apartment" />

      <button id="startBtn">Iniciar Quiz</button>
    </div>

    <div id="quizScreen">
      <div id="userInfo"></div>
      <h3>Pergunta <span id="qIndex"></span> de <span id="qTotal"></span></h3>
      <p id="questionText"></p>
      <button id="btnFraud">Fraude</button>
      <button id="btnSafe">Não é fraude</button>
      <div id="feedbackBox"></div>
      <button id="nextBtn" style="display:none;">Próxima</button>
      <p style="font-weight:600; margin-top: 15px;">Pontuação: <span id="score">0</span></p>
    </div>

    <div id="resultScreen">
      <h2 id="resTitle">Resultado Final</h2>
      <div id="resInfo">
        <p><strong>Nome:</strong> <span id="resName"></span></p>
        <p><strong>Torre:</strong> <span id="resTower"></span></p>
        <p><strong>Pontuação final:</strong> <span id="finalScore"></span></p>
      </div>

      <h3>Ranking dos moradores</h3>
      <table id="leaderboardTable" aria-label="Ranking dos moradores">
        <thead>
          <tr><th>Posição</th><th>Nome</th><th>Torre</th><th>Pontuação</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3>Desempenho por faixa etária</h3>
      <table id="ageStatsTable" aria-label="Desempenho por faixa etária">
        <thead>
          <tr><th>Faixa Etária</th><th>Quantidade</th><th>Média de Acertos</th><th>Percentual (%)</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="downloadCSVBtn" style="margin-top:20px; display:none;">Baixar resultados em CSV</button>
      <button id="restartBtn" style="margin-top:20px;">Reiniciar</button>
    </div>

  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtSr5znaGgvN9ZyITfCJzZD4jRpthAat0",
  authDomain: "trabalho-final-ohcao.firebaseapp.com",
  projectId: "trabalho-final-ohcao",
  storageBucket: "trabalho-final-ohcao.appspot.com",
  messagingSenderId: "588002956461",
  appId: "1:588002956461:web:12eec38aceece890e56224"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Perguntas fixas (8 perguntas)
const SCENARIOS = [
  { question: "Você recebe uma mensagem de um contato desconhecido pedindo dinheiro urgente. O que fazer?", correct: true, explanation: "É uma fraude comum se passar por conhecidos pedindo dinheiro. Nunca envie sem confirmar pessoalmente." },
  { question: "Um site pede para você atualizar seus dados bancários via link no e-mail. Isso é seguro?", correct: true, explanation: "Sites legítimos não pedem atualização via links em e-mails. Pode ser phishing." },
  { question: "Você recebeu um telefonema dizendo que ganhou um prêmio e precisa informar seus dados. É confiável?", correct: true, explanation: "Golpistas usam essa tática para coletar dados. Nunca forneça dados por telefone sem certeza." },
  { question: "Um aplicativo na loja oficial tem avaliações negativas dizendo que pode ser perigoso. Você deve instalar?", correct: true, explanation: "Avaliações negativas são um alerta. É melhor não instalar aplicativos suspeitos." },
  { question: "Uma mensagem do seu banco pede para confirmar uma transação via WhatsApp. Você deve confirmar?", correct: true, explanation: "Bancos nunca pedem confirmação de transação por WhatsApp. Pode ser golpe." },
  { question: "Você recebeu uma oferta de desconto muito grande em redes sociais, mas o link leva para um site estranho. Você deve clicar?", correct: true, explanation: "Links suspeitos podem roubar seus dados. Não clique em links de fontes desconhecidas." },
  { question: "Um site que você acessa frequentemente pediu para mudar sua senha por motivo de segurança. É recomendável?", correct: false, explanation: "Alterar senhas periodicamente é uma boa prática de segurança." },
  { question: "Usar senhas fortes e diferentes para cada serviço ajuda a proteger suas contas. Isso é verdade?", correct: false, explanation: "Senhas fortes e diferentes dificultam o acesso não autorizado." }
];

let index = 0;
let score = 0;
let user = {};
let isUninter = false;

const LB_KEY = "ranking_condominio_fixed";
const ANSWERED_KEY = "usuarios_respondidos_condominio";
const AGE_STATS_KEY = "estatisticas_idade_condominio";

const startScreen = document.getElementById("startScreen");
const quizScreen = document.getElementById("quizScreen");
const resultScreen = document.getElementById("resultScreen");
const startBtn = document.getElementById("startBtn");
const btnFraud = document.getElementById("btnFraud");
const btnSafe = document.getElementById("btnSafe");
const nextBtn = document.getElementById("nextBtn");
const questionText = document.getElementById("questionText");
const qIndexEl = document.getElementById("qIndex");
const qTotalEl = document.getElementById("qTotal");
const scoreEl = document.getElementById("score");
const feedbackBox = document.getElementById("feedbackBox");
const userInfoEl = document.getElementById("userInfo");
const resNameEl = document.getElementById("resName");
const resTowerEl = document.getElementById("resTower");
const finalScoreEl = document.getElementById("finalScore");
const leaderboardTable = document.getElementById("leaderboardTable").querySelector("tbody");
const ageStatsTable = document.getElementById("ageStatsTable").querySelector("tbody");
const downloadCSVBtn = document.getElementById("downloadCSVBtn");
const restartBtn = document.getElementById("restartBtn");

startBtn.addEventListener("click", () => {
  const name = document.getElementById("name").value.trim();
  const age = parseInt(document.getElementById("age").value);
  const tower = parseInt(document.getElementById("tower").value);
  const apartment = document.getElementById("apartment").value.trim();

  // Usuário uninter entra direto, sem validação
  isUninter = name.toLowerCase() === "uninter";

  if(!isUninter) {
    if(!name || !age || !tower || !apartment) {
      alert("Por favor, preencha todos os campos.");
      return;
    }
  }

  user = { name, age, tower, apartment };
  startScreen.style.display = "none";
  quizScreen.style.display = "block";

  userInfoEl.textContent = isUninter ? "Usuário Uninter (visualização de resultados)" : `${name} - Torre ${tower}`;
  qTotalEl.textContent = SCENARIOS.length;
  showQuestion();
});

function showQuestion() {
  const current = SCENARIOS[index];
  questionText.textContent = current.question;
  qIndexEl.textContent = index + 1;
  feedbackBox.textContent = "";
  feedbackBox.className = "";
  btnFraud.disabled = false;
  btnSafe.disabled = false;
  nextBtn.style.display = "none";
}

function checkAnswer(answer) {
  const correct = SCENARIOS[index].correct;
  btnFraud.disabled = true;
  btnSafe.disabled = true;
  if(answer === correct) {
    score++;
    feedbackBox.textContent = "Correto! ✅";
    feedbackBox.className = "correct";
  } else {
    feedbackBox.textContent = "Incorreto ❌";
    feedbackBox.className = "wrong";
  }
  nextBtn.style.display = "inline-block";
}

btnFraud.addEventListener("click", () => checkAnswer(true));
btnSafe.addEventListener("click", () => checkAnswer(false));

nextBtn.addEventListener("click", () => {
  index++;
  if(index < SCENARIOS.length) {
    showQuestion();
  } else {
    endQuiz();
  }
});

async function endQuiz() {
  quizScreen.style.display = "none";
  resultScreen.style.display = "block";

  resNameEl.textContent = user.name;
  resTowerEl.textContent = user.tower || "-";
  finalScoreEl.textContent = score;

  // Salvar no Firestore se não for uninter
  if(!isUninter) {
    await addDoc(collection(db, "quiz_results"), {
      name: user.name,
      age: user.age,
      tower: user.tower,
      apartment: user.apartment,
      score,
      timestamp: new Date()
    });
  }

  await updateLeaderboardAndStats();
}

async function updateLeaderboardAndStats() {
  const q = query(collection(db, "quiz_results"), orderBy("score", "desc"));
  const snapshot = await getDocs(q);
  const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  // Atualiza ranking
  leaderboardTable.innerHTML = "";
  data.forEach((item, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${idx+1}</td><td>${item.name}</td><td>${item.tower || "-"}</td><td>${item.score}</td>`;
    leaderboardTable.appendChild(tr);
  });

  // Estatísticas por faixa etária
  const ranges = [
    { label: "50–59", min: 50, max: 59 },
    { label: "60–69", min: 60, max: 69 },
    { label: "70–79", min: 70, max: 79 },
    { label: "80+", min: 80, max: 200 }
  ];

  ageStatsTable.innerHTML = "";
  ranges.forEach(r => {
    const filtered = data.filter(u => u.age >= r.min && u.age <= r.max);
    const avg = filtered.length ? (filtered.reduce((a,b)=>a+b.score,0)/filtered.length).toFixed(2) : 0;
    const percent = filtered.length ? ((avg/SCENARIOS.length)*100).toFixed(0) : 0;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.label}</td><td>${filtered.length}</td><td>${avg}</td><td>${percent}</td>`;
    ageStatsTable.appendChild(tr);
  });

  // Mostrar botão CSV apenas para uninter
  if(isUninter) {
    downloadCSVBtn.style.display = "inline-block";
  }
}

// Download CSV
downloadCSVBtn.addEventListener("click", () => {
  const rows = [["Nome","Torre","Apartamento","Idade","Pontuação","Data/Hora"]];
  Array.from(leaderboardTable.querySelectorAll("tr")).forEach((tr,i)=>{
    if(i===0) return; // cabeçalho
    const tds = tr.querySelectorAll("td");
    const userData = data[i-1];
    rows.push([userData.name, userData.tower, userData.apartment, userData.age, userData.score, new Date(userData.timestamp.seconds*1000).toLocaleString()]);
  });
  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "resultados_quiz.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

restartBtn.addEventListener("click", () => location.reload());
</script>
</body>
</html>
